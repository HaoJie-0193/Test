# 账号管理系统详细设计

## TG 批量授权文件导入系统

### 1. TG Session 文件管理架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            TG 账号授权文件管理系统                              │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                            文件上传处理层                                    │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │ │
│  │  │ 批量上传     │ │ 文件验证     │ │ 格式检查     │ │      安全扫描           │ │ │
│  │  │ Drag & Drop │ │ Session验证  │ │ .session     │ │      病毒检测           │ │ │
│  │  │ 多文件选择   │ │ 文件完整性   │ │ .json        │ │      恶意代码扫描       │ │ │
│  │  │ 进度显示     │ │ 大小限制     │ │ .db          │ │      文件签名验证       │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                         │
│                                        ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                            Session 解析处理层                               │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │ │
│  │  │ Session解析 │ │ 账号信息提取 │ │ 权限验证     │ │      状态检测           │ │ │
│  │  │ Telethon    │ │ User ID     │ │ API权限     │ │      账号活跃度         │ │ │
│  │  │ SQLite读取  │ │ Phone       │ │ 群组权限     │ │      登录状态           │ │ │
│  │  │ 数据解密     │ │ Username    │ │ 频道权限     │ │      风险评估           │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                         │
│                                        ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                            账号池管理层                                      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │ │
│  │  │ 账号分组     │ │ 标签管理     │ │ 质量评级     │ │      使用统计           │ │ │
│  │  │ 按地域分组   │ │ 自定义标签   │ │ A级高质量   │ │      成功率统计         │ │ │
│  │  │ 按用途分组   │ │ 业务标签     │ │ B级中等     │ │      活跃度监控         │ │ │
│  │  │ 按状态分组   │ │ 风险标签     │ │ C级待观察   │ │      异常行为检测       │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                         │
│                                        ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                            安全存储层                                        │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │ │
│  │  │ 加密存储     │ │ 访问控制     │ │ 审计日志     │ │      备份恢复           │ │ │
│  │  │ AES-256     │ │ RBAC权限    │ │ 操作记录     │ │      定时备份           │ │ │
│  │  │ 密钥轮换     │ │ 最小权限     │ │ 访问追踪     │ │      灾难恢复           │ │ │
│  │  │ 分离存储     │ │ 时间限制     │ │ 变更记录     │ │      数据一致性         │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2. 批量导入详细流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            批量导入处理流程                                     │
│                                                                                 │
│  步骤1: 文件上传                                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │  前端界面                  →    后端处理                                     │ │
│  │  ┌─────────────────────┐        ┌─────────────────────────────────────────┐  │ │
│  │  │ • 拖拽上传区域       │   →    │ • 文件大小检查 (< 100MB)               │  │ │
│  │  │ • 多文件选择         │        │ • 文件类型验证 (.session/.json/.db)    │  │ │
│  │  │ • 上传进度条         │        │ • 病毒扫描检查                         │  │ │
│  │  │ • 预览文件列表       │        │ • 临时存储到安全目录                   │  │ │
│  │  └─────────────────────┘        └─────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                         │
│                                        ▼                                         │
│  步骤2: Session 解析                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────────┐│ │
│  │  │   .session文件  │  │   .json文件     │  │         .db文件                ││ │
│  │  │                 │  │                 │  │                               ││ │
│  │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────────────────────┐││ │
│  │  │ │Telethon     │ │  │ │JSON解析     │ │  │ │SQLite数据库读取           │││ │
│  │  │ │Client读取   │ │  │ │用户数据提取 │ │  │ │会话数据解析               │││ │
│  │  │ │会话数据     │ │  │ │API密钥验证  │ │  │ │权限信息获取               │││ │
│  │  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────────────────────┘││ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────────────┘│ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                         │
│                                        ▼                                         │
│  步骤3: 账号验证                                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │  验证项目                           处理结果                                 │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │ ✓ 账号有效性验证                 → 标记: 有效/无效/待验证               │ │ │
│  │  │ ✓ API权限检查                   → 权限: 完整/受限/无权限               │ │ │
│  │  │ ✓ 账号状态检测                   → 状态: 正常/受限/封禁                 │ │ │
│  │  │ ✓ 重复账号检查                   → 操作: 跳过/覆盖/合并                 │ │ │
│  │  │ ✓ 地域限制检查                   → 地区: 可用区域标记                   │ │ │
│  │  │ ✓ 风险评估                      → 风险: 低/中/高风险等级               │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                         │
│                                        ▼                                         │
│  步骤4: 数据入库                                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │  数据库表结构                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │ accounts 表:                                                            │ │ │
│  │  │ - id (主键)                                                             │ │ │
│  │  │ - user_id (TG用户ID)                                                    │ │ │
│  │  │ - phone (手机号，加密存储)                                              │ │ │
│  │  │ - username (用户名)                                                     │ │ │
│  │  │ - session_data (会话数据，加密存储)                                     │ │ │
│  │  │ - quality_level (质量等级: A/B/C)                                       │ │ │
│  │  │ - status (状态: active/inactive/banned)                                 │ │ │
│  │  │ - risk_level (风险等级: low/medium/high)                                │ │ │
│  │  │ - tags (标签，JSON格式)                                                 │ │ │
│  │  │ - last_used_at (最后使用时间)                                           │ │ │
│  │  │ - created_at, updated_at                                                │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5. 实现代码示例

#### TG Session 文件解析器 (Python)

```python
import sqlite3
import json
import os
from typing import Dict, List, Optional
from telethon import TelegramClient
from telethon.sessions import StringSession
import asyncio

class TGSessionManager:
    def __init__(self, api_id: int, api_hash: str):
        self.api_id = api_id
        self.api_hash = api_hash
    
    async def parse_session_file(self, session_path: str) -> Dict:
        """解析 session 文件并提取账号信息"""
        try:
            # 检查文件类型
            if session_path.endswith('.session'):
                return await self._parse_sqlite_session(session_path)
            elif session_path.endswith('.json'):
                return await self._parse_json_session(session_path)
            else:
                raise ValueError("不支持的文件格式")
        except Exception as e:
            return {"error": str(e), "valid": False}
    
    async def _parse_sqlite_session(self, session_path: str) -> Dict:
        """解析 SQLite session 文件"""
        conn = sqlite3.connect(session_path)
        cursor = conn.cursor()
        
        # 读取会话数据
        cursor.execute("SELECT * FROM sessions")
        session_data = cursor.fetchone()
        
        if not session_data:
            return {"error": "Session 数据为空", "valid": False}
        
        # 创建临时客户端验证
        session_string = StringSession()
        client = TelegramClient(session_string, self.api_id, self.api_hash)
        
        try:
            await client.connect()
            if await client.is_user_authorized():
                me = await client.get_me()
                return {
                    "valid": True,
                    "user_id": me.id,
                    "phone": me.phone,
                    "username": me.username,
                    "first_name": me.first_name,
                    "last_name": me.last_name,
                    "session_string": session_string.save()
                }
            else:
                return {"error": "Session 已过期", "valid": False}
        finally:
            await client.disconnect()
            conn.close()
    
    async def batch_import_sessions(self, file_paths: List[str]) -> List[Dict]:
        """批量导入 session 文件"""
        results = []
        for file_path in file_paths:
            result = await self.parse_session_file(file_path)
            result['file_path'] = file_path
            results.append(result)
        return results

# 使用示例
async def main():
    manager = TGSessionManager(api_id=12345, api_hash="your_api_hash")
    
    # 批量处理
    session_files = [
        "/path/to/session1.session",
        "/path/to/session2.session",
        "/path/to/account.json"
    ]
    
    results = await manager.batch_import_sessions(session_files)
    
    for result in results:
        if result['valid']:
            print(f"成功: {result['phone']} - {result['username']}")
        else:
            print(f"失败: {result['file_path']} - {result['error']}")

# asyncio.run(main())
```

#### 文件上传 API 接口 (NestJS)

```typescript
// account-upload.controller.ts
import { Controller, Post, UseInterceptors, UploadedFiles, Body } from '@nestjs/common';
import { FilesInterceptor } from '@nestjs/platform-express';
import { AccountImportService } from './account-import.service';

@Controller('api/accounts')
export class AccountUploadController {
  constructor(private readonly importService: AccountImportService) {}

  @Post('import/batch')
  @UseInterceptors(FilesInterceptor('files', 100, {
    limits: { fileSize: 100 * 1024 * 1024 }, // 100MB
    fileFilter: (req, file, cb) => {
      const allowedTypes = ['.session', '.json', '.db'];
      const isAllowed = allowedTypes.some(type => 
        file.originalname.toLowerCase().endsWith(type)
      );
      cb(null, isAllowed);
    }
  }))
  async batchImportAccounts(
    @UploadedFiles() files: Express.Multer.File[],
    @Body() importOptions: any
  ) {
    try {
      const results = await this.importService.processBatchImport(files, importOptions);
      
      return {
        success: true,
        total: files.length,
        imported: results.filter(r => r.success).length,
        failed: results.filter(r => !r.success).length,
        results: results
      };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  }
}

// account-import.service.ts
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Account } from './entities/account.entity';
import * as crypto from 'crypto';

@Injectable()
export class AccountImportService {
  constructor(
    @InjectRepository(Account)
    private accountRepository: Repository<Account>
  ) {}

  async processBatchImport(files: Express.Multer.File[], options: any) {
    const results = [];
    
    for (const file of files) {
      try {
        // 1. 安全检查
        await this.validateFile(file);
        
        // 2. 解析文件
        const accountData = await this.parseAccountFile(file);
        
        // 3. 检查重复
        const existing = await this.findExistingAccount(accountData.user_id);
        if (existing && !options.allowDuplicate) {
          results.push({
            filename: file.originalname,
            success: false,
            error: '账号已存在'
          });
          continue;
        }
        
        // 4. 质量评估
        const qualityScore = await this.assessAccountQuality(accountData);
        
        // 5. 加密存储
        const encryptedData = this.encryptSensitiveData(accountData);
        
        // 6. 保存到数据库
        const account = await this.saveAccount({
          ...encryptedData,
          qualityScore,
          importedAt: new Date(),
          status: 'active'
        });
        
        results.push({
          filename: file.originalname,
          success: true,
          accountId: account.id,
          quality: qualityScore
        });
        
      } catch (error) {
        results.push({
          filename: file.originalname,
          success: false,
          error: error.message
        });
      }
    }
    
    return results;
  }
  
  private async validateFile(file: Express.Multer.File): Promise<void> {
    // 文件大小检查
    if (file.size > 100 * 1024 * 1024) {
      throw new Error('文件过大');
    }
    
    // 文件类型检查
    const allowedTypes = ['.session', '.json', '.db'];
    if (!allowedTypes.some(type => file.originalname.endsWith(type))) {
      throw new Error('不支持的文件类型');
    }
    
    // 病毒扫描 (集成第三方扫描服务)
    // await this.virusScanService.scan(file.buffer);
  }
  
  private encryptSensitiveData(data: any): any {
    const key = process.env.ENCRYPTION_KEY;
    
    // 加密敏感字段
    if (data.phone) {
      data.phone = this.encrypt(data.phone, key);
    }
    if (data.session_string) {
      data.session_string = this.encrypt(data.session_string, key);
    }
    
    return data;
  }
  
  private encrypt(text: string, key: string): string {
    const algorithm = 'aes-256-gcm';
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(algorithm, key);
    
    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    return iv.toString('hex') + ':' + encrypted;
  }
}
```

## WhatsApp 接口集成方案研究

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u5b8c\u5584TG\u6279\u91cf\u6388\u6743\u6587\u4ef6\u5bfc\u5165\u529f\u80fd\u8bbe\u8ba1", "status": "completed", "activeForm": "\u5b8c\u5584TG\u6279\u91cf\u6388\u6743\u6587\u4ef6\u5bfc\u5165\u529f\u80fd\u8bbe\u8ba1"}, {"content": "\u7814\u7a76WA\u63a5\u53e3\u96c6\u6210\u65b9\u6848", "status": "in_progress", "activeForm": "\u7814\u7a76WA\u63a5\u53e3\u96c6\u6210\u65b9\u6848"}, {"content": "\u521b\u5efaMermaid\u56fe\u8868\u7248\u67b6\u6784\u56fe", "status": "pending", "activeForm": "\u521b\u5efaMermaid\u56fe\u8868\u7248\u67b6\u6784\u56fe"}, {"content": "\u8bbe\u8ba1\u8d26\u53f7\u7ba1\u7406\u8be6\u7ec6\u6d41\u7a0b", "status": "pending", "activeForm": "\u8bbe\u8ba1\u8d26\u53f7\u7ba1\u7406\u8be6\u7ec6\u6d41\u7a0b"}]