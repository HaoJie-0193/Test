# 服务发现与配置管理详细设计

## 服务发现架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          服务发现与注册中心集群                                  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                            Consul 集群                                      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │ │
│  │  │   Leader    │ │  Follower   │ │  Follower   │ │      KV Store           │ │ │
│  │  │  节点1       │ │   节点2      │ │   节点3      │ │      键值存储           │ │ │
│  │  │ 服务注册     │ │  服务发现    │ │  健康检查    │ │      配置数据           │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           Nacos 集群 (备选方案)                              │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │ │
│  │  │  Nacos-1    │ │  Nacos-2    │ │  Nacos-3    │ │     配置中心             │ │ │
│  │  │ 服务注册     │ │  服务发现    │ │  配置管理    │ │     Config Center       │ │ │
│  │  │ Discovery   │ │ Discovery   │ │  Config     │ │     动态配置             │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                              服务注册与发现
                                        │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              微服务实例集群                                      │
│                                                                                 │
│  ┌───────────────┬───────────────┬───────────────┬───────────────────────────────┐ │
│  │   用户服务     │   TG控制服务   │   WA控制服务   │      智能回复服务             │ │
│  │ User Service  │ TG Controller │ WA Controller │   AI Reply Service           │ │
│  │               │               │               │                             │ │
│  │ ┌───────────┐ │ ┌───────────┐ │ ┌───────────┐ │ ┌─────────────────────────┐   │ │
│  │ │实例1:8001 │ │ │实例1:8002 │ │ │实例1:8003 │ │ │    实例1:8004           │   │ │
│  │ │健康检查   │ │ │健康检查   │ │ │健康检查   │ │ │    健康检查             │   │ │
│  │ │自动注册   │ │ │自动注册   │ │ │自动注册   │ │ │    自动注册             │   │ │
│  │ └───────────┘ │ └───────────┘ │ └───────────┘ │ └─────────────────────────┘   │ │
│  │ ┌───────────┐ │ ┌───────────┐ │ ┌───────────┐ │ ┌─────────────────────────┐   │ │
│  │ │实例2:8011 │ │ │实例2:8012 │ │ │实例2:8013 │ │ │    实例2:8014           │   │ │
│  │ │健康检查   │ │ │健康检查   │ │ │健康检查   │ │ │    健康检查             │   │ │
│  │ │自动注册   │ │ │自动注册   │ │ │自动注册   │ │ │    自动注册             │   │ │
│  │ └───────────┘ │ └───────────┘ │ └───────────┘ │ └─────────────────────────┘   │ │
│  └───────────────┴───────────────┴───────────────┴───────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 配置管理架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            配置管理中心集群                                      │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                         Apollo 配置中心                                     │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │ │
│  │  │ Config DB   │ │ Admin Svc   │ │Config Svc   │ │      Portal             │ │ │
│  │  │ 配置存储     │ │  管理服务    │ │  配置服务    │ │      管理界面           │ │ │
│  │  │ MySQL       │ │  配置管理    │ │  配置分发    │ │      Web Portal         │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        配置层级结构                                         │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │ │
│  │  │  全局配置   │ │  环境配置    │ │  应用配置    │ │      集群配置           │ │ │
│  │  │ Global      │ │Environment  │ │Application  │ │      Cluster            │ │ │
│  │  │ 通用设置     │ │dev/test/prod│ │ 应用特定     │ │      灰度发布           │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                 配置推送与拉取
                                        │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              微服务配置客户端                                    │
│                                                                                 │
│  ┌───────────────┬───────────────┬───────────────┬───────────────────────────────┐ │
│  │   用户服务     │   TG控制服务   │   WA控制服务   │      智能回复服务             │ │
│  │               │               │               │                             │ │
│  │ ┌───────────┐ │ ┌───────────┐ │ ┌───────────┐ │ ┌─────────────────────────┐   │ │
│  │ │配置客户端 │ │ │配置客户端 │ │ │配置客户端 │ │ │    配置客户端           │   │ │
│  │ │Apollo SDK │ │ │Apollo SDK │ │ │Apollo SDK │ │ │    Apollo SDK           │   │ │
│  │ │自动刷新   │ │ │自动刷新   │ │ │自动刷新   │ │ │    自动刷新             │   │ │
│  │ └───────────┘ │ └───────────┘ │ └───────────┘ │ └─────────────────────────┘   │ │
│  │ 配置项:       │ │ 配置项:       │ │ 配置项:       │ │ 配置项:                 │   │ │
│  │ - JWT密钥     │ │ - API密钥     │ │ - API密钥     │ │ - OpenAI Key            │   │ │
│  │ - DB连接      │ │ - 代理设置    │ │ - 代理设置    │ │ - 模型配置              │   │ │
│  │ - 日志级别    │ │ - 限流配置    │ │ - 限流配置    │ │ - Prompt模板            │   │ │
│  └───────────────┴───────────────┴───────────────┴───────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 服务发现流程

### 1. 服务注册流程
```
服务启动 → 读取配置 → 向Consul注册 → 设置健康检查 → 开始提供服务
   │           │            │             │              │
   │           │            │             │              ▼
   │           │            │             │        ┌──────────────┐
   │           │            │             │        │   开始接受   │
   │           │            │             │        │   请求流量   │
   │           │            │             │        └──────────────┘
   │           │            │             │
   │           │            │             ▼
   │           │            │        ┌──────────────┐
   │           │            │        │   设置健康   │
   │           │            │        │   检查端点   │
   │           │            │        └──────────────┘
   │           │            │
   │           │            ▼
   │           │       ┌──────────────┐
   │           │       │   注册服务   │
   │           │       │   到Consul   │
   │           │       └──────────────┘
   │           │
   │           ▼
   │      ┌──────────────┐
   │      │   读取启动   │
   │      │   配置参数   │
   │      └──────────────┘
   │
   ▼
┌──────────────┐
│   服务实例   │
│   启动开始   │
└──────────────┘
```

### 2. 服务发现流程
```
客户端请求 → 查询Consul → 获取服务列表 → 负载均衡选择 → 调用目标服务
     │           │             │              │              │
     │           │             │              │              ▼
     │           │             │              │        ┌──────────────┐
     │           │             │              │        │   执行远程   │
     │           │             │              │        │   服务调用   │
     │           │             │              │        └──────────────┘
     │           │             │              │
     │           │             │              ▼
     │           │             │        ┌──────────────┐
     │           │             │        │   负载均衡   │
     │           │             │        │   算法选择   │
     │           │             │        │   实例地址   │
     │           │             │        └──────────────┘
     │           │             │
     │           │             ▼
     │           │        ┌──────────────┐
     │           │        │   返回可用   │
     │           │        │   服务实例   │
     │           │        │   列表      │
     │           │        └──────────────┘
     │           │
     │           ▼
     │      ┌──────────────┐
     │      │   查询服务   │
     │      │   注册中心   │
     │      └──────────────┘
     │
     ▼
┌──────────────┐
│   微服务A    │
│   需要调用   │
│   微服务B    │
└──────────────┘
```

## 配置管理关键特性

### 1. 配置热更新
- **实时推送**: Apollo配置变更实时推送到客户端
- **优雅重载**: 支持配置热更新而无需重启服务
- **回滚机制**: 支持配置版本回滚

### 2. 环境隔离
```
开发环境 (DEV)
├── 数据库配置: dev.mysql.host
├── Redis配置: dev.redis.host  
├── API密钥: dev.openai.key
└── 日志级别: DEBUG

测试环境 (TEST)  
├── 数据库配置: test.mysql.host
├── Redis配置: test.redis.host
├── API密钥: test.openai.key
└── 日志级别: INFO

生产环境 (PROD)
├── 数据库配置: prod.mysql.host
├── Redis配置: prod.redis.host  
├── API密钥: prod.openai.key
└── 日志级别: WARN
```

### 3. 权限管理
- **角色分离**: 开发者/运维/管理员不同权限
- **环境隔离**: 开发者只能修改DEV环境配置
- **审核流程**: 生产环境配置变更需要审核

## 技术实现方案

### Consul 集成示例 (Go)
```go
package main

import (
    "github.com/hashicorp/consul/api"
    "log"
)

type ServiceRegistry struct {
    client *api.Client
}

func NewServiceRegistry() *ServiceRegistry {
    config := api.DefaultConfig()
    config.Address = "consul:8500"
    client, err := api.NewClient(config)
    if err != nil {
        log.Fatal(err)
    }
    return &ServiceRegistry{client: client}
}

func (sr *ServiceRegistry) RegisterService(name, address string, port int) error {
    service := &api.AgentServiceRegistration{
        ID:      name + "-" + address,
        Name:    name,
        Tags:    []string{"api", "v1"},
        Port:    port,
        Address: address,
        Check: &api.AgentServiceCheck{
            HTTP:     fmt.Sprintf("http://%s:%d/health", address, port),
            Interval: "10s",
        },
    }
    return sr.client.Agent().ServiceRegister(service)
}

func (sr *ServiceRegistry) DiscoverService(serviceName string) ([]string, error) {
    services, _, err := sr.client.Health().Service(serviceName, "", true, nil)
    if err != nil {
        return nil, err
    }
    
    var addresses []string
    for _, service := range services {
        addr := fmt.Sprintf("%s:%d", 
            service.Service.Address, 
            service.Service.Port)
        addresses = append(addresses, addr)
    }
    return addresses, nil
}
```

### Apollo 配置客户端示例 (Node.js)
```javascript
const Apollo = require('ctrip-apollo');

class ConfigManager {
    constructor() {
        this.apollo = new Apollo({
            host: 'http://apollo-config:8070',
            appId: 'tg-wa-saas',
            clusterName: 'default',
            namespaceName: 'application',
            ip: process.env.HOST_IP
        });
        
        this.config = {};
        this.initConfig();
    }
    
    async initConfig() {
        // 初始化配置
        this.config = await this.apollo.remoteConfigService();
        
        // 监听配置变更
        this.apollo.on('change', (data) => {
            console.log('Config changed:', data);
            this.handleConfigChange(data);
        });
    }
    
    handleConfigChange(changes) {
        for (const change of changes) {
            this.config[change.key] = change.newValue;
            
            // 根据配置类型处理热更新
            switch (change.key) {
                case 'database.pool.size':
                    this.updateDatabasePool();
                    break;
                case 'ai.openai.key':
                    this.updateAIService();
                    break;
                case 'log.level':
                    this.updateLogLevel();
                    break;
            }
        }
    }
    
    get(key, defaultValue = null) {
        return this.config[key] || defaultValue;
    }
}

module.exports = ConfigManager;
```

## 部署建议

### Consul 集群部署
- **节点数量**: 3或5个节点(奇数)
- **硬件配置**: 2C4G + SSD存储
- **网络要求**: 低延迟内网环境
- **数据备份**: 定期备份KV存储

### Apollo 配置中心部署  
- **Config DB**: MySQL主从架构
- **Config Service**: 至少2个实例
- **Admin Service**: 至少2个实例  
- **Portal**: 1个实例即可

这套服务发现与配置管理方案提供了企业级的可靠性和可扩展性，支持你的 TG + WA 群控 SaaS 系统的微服务架构需求。